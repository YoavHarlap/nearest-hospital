<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fast2Care — Top 4 ב-Google Maps</title>
  <style>
    body { font-family: system-ui, Arial; margin: 16px; line-height: 1.35; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin-top: 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input, button { padding: 10px; font-size: 16px; }
    button { cursor: pointer; }
    .muted { color: #555; }
    .ok { color: #0a7; }
    .bad { color: #c00; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #eee; padding: 8px; vertical-align: top; }
    th { background: #f7f7f7; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }
    .big { font-size: 16px; padding: 12px; font-weight: 700; }
    .stack { display:flex; flex-direction:column; gap:6px; }
  </style>
</head>
<body>
  <h2>Fast2Care — מיון אווירי + פתיחת 4 הקרובים ב-Google Maps</h2>
  <div class="muted">
    ממיין לפי מרחק אווירי ואז בלחיצה אחת פותח 4 יעדים ב-Google Maps כדי לראות ETA מהר.
    פתיחה לגוגל נעשית עם <b>שם בית החולים</b> (ולא רק נ״צ), ובפורמט “וובי” כדי להפחית קפיצה לאפליקציה.
  </div>

  <div class="card">
    <h3>המיקום שלי</h3>
    <div class="row">
      <button id="btnLocate" class="big">אתר מיקום</button>
      <button id="btnOpenTop4" class="big" disabled>פתח 4 הכי קרובים ב-Google Maps</button>
      <span id="status" class="muted">מוכן.</span>
      <span id="count" class="pill"></span>
    </div>
    <div id="addr" class="muted" style="margin-top:8px"></div>
    <div class="muted" style="margin-top:6px">
      אם כרום חוסם Pop-ups: תפריט ⋮ → Settings → Site settings → Pop-ups and redirects → Allow (לאתר שלך).
      <br/>
      אם עדיין נפתח באפליקציה: Settings → Apps → Maps → Open by default → Open supported links → Don’t allow.
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">בתי חולים (ממויין לפי מרחק אווירי)</h3>
      <input id="search" placeholder="חיפוש לפי שם..." style="min-width:180px" />
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th style="width:44%">שם</th>
          <th style="width:16%">אווירי</th>
          <th style="width:40%">פתיחה מהירה</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
/** כמה כרטיסיות לפתוח */
const OPEN_TOP_N = 4;

/** דיפולט לדוגמה — החלף לרשימת 15 שלך */
let hospitals = [
  { id: crypto.randomUUID(), name: "איכילוב (דוגמה)", lat: 32.0781, lng: 34.7898 },
  { id: crypto.randomUUID(), name: "שיבא תל השומר (דוגמה)", lat: 32.0460, lng: 34.8447 },
  { id: crypto.randomUUID(), name: "בלינסון (דוגמה)", lat: 32.0910, lng: 34.8814 },
  { id: crypto.randomUUID(), name: "וולפסון (דוגמה)", lat: 32.0168, lng: 34.7580 },
  { id: crypto.randomUUID(), name: "אסותא רמת החייל (דוגמה)", lat: 32.1093, lng: 34.8416 },
  { id: crypto.randomUUID(), name: "רמב\"ם חיפה (דוגמה)", lat: 32.8371, lng: 35.0506 },
];

let myPos = null;
let sorted = [];

const el = (id) => document.getElementById(id);

function setStatus(msg, ok=true) {
  el("status").textContent = msg;
  el("status").className = ok ? "ok" : "bad";
}

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

/** מרחק אווירי */
function haversineKm(a, b) {
  const R = 6371;
  const toRad = (x) => x * Math.PI / 180;
  const dLat = toRad(b.lat - a.lat);
  const dLng = toRad(b.lng - a.lng);
  const lat1 = toRad(a.lat);
  const lat2 = toRad(b.lat);
  const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
  return 2 * R * Math.asin(Math.min(1, Math.sqrt(h)));
}

/**
 * ✅ Google Maps URL "וובי" שמנסה להפחית מעבר לאפליקציה
 * ✅ משתמש בשם בית החולים כיעד (daddr) כדי שתראה שם ולא רק נ״צ
 *
 * הערה: אם באנדרואיד מוגדר App Links ל-Maps, לפעמים עדיין יעבור לאפליקציה.
 * במקרה כזה צריך לבטל "Open supported links" באפליקציית Maps.
 */
function googleMapsDirUrl(destLat, destLng, destName) {
  const base = "https://www.google.com/maps";
  const origin = myPos ? `${myPos.lat},${myPos.lng}` : "";
  const saddr = encodeURIComponent(origin);
  // יעד: קודם שם (נוח לזיהוי), ואם אין שם אז נ״צ
  const daddr = encodeURIComponent(destName || (destLat + "," + destLng));
  return `${base}?output=classic&dirflg=d&saddr=${saddr}&daddr=${daddr}`;
}

/** Waze deep link (עדיין ייתכן שייפתח באפליקציה וזה בסדר) */
function wazeUrl(destLat, destLng) {
  return `https://waze.com/ul?ll=${encodeURIComponent(destLat + "," + destLng)}&navigate=yes`;
}

/** זיהוי כתובת: עיר + רחוב + מספר (Nominatim) */
async function reverseAddress(lat, lng) {
  try {
    const url = new URL("https://nominatim.openstreetmap.org/reverse");
    url.searchParams.set("format", "jsonv2");
    url.searchParams.set("lat", lat);
    url.searchParams.set("lon", lng);
    url.searchParams.set("accept-language", "he");
    const r = await fetch(url.toString(), { headers: { "Accept": "application/json" }});
    if (!r.ok) throw new Error("reverse http " + r.status);
    const data = await r.json();
    const a = data.address || {};
    const city = a.city || a.town || a.village || a.municipality || "";
    const road = a.road || a.pedestrian || a.footway || "";
    const num  = a.house_number || "";
    const parts = [];
    if (city) parts.push(city);
    if (road) parts.push(road + (num ? " " + num : ""));
    return parts.length ? `זוהית ב: ${parts.join(", ")}` : "זוהית מיקום (לא הצלחתי לזהות כתובת).";
  } catch {
    return "זוהית מיקום (זיהוי כתובת נכשל).";
  }
}

function render() {
  const q = el("search").value.trim().toLowerCase();
  const list = sorted.filter(h => !q || h.name.toLowerCase().includes(q));

  el("count").textContent = `${list.length} מתוך ${sorted.length || hospitals.length}`;

  const tbody = el("tbl").querySelector("tbody");
  tbody.innerHTML = "";

  list.forEach(h => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${escapeHtml(h.name)}</b></td>
      <td>${Number.isFinite(h.air_km) ? `${h.air_km.toFixed(1)} ק״מ` : `<span class="muted">—</span>`}</td>
      <td>
        <div class="stack">
          <button data-act="gmaps" data-id="${h.id}">Google Maps (ראה ETA)</button>
          <button data-act="waze" data-id="${h.id}">Waze</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("button[data-act]").forEach(btn => {
    btn.addEventListener("click", () => {
      const act = btn.getAttribute("data-act");
      const id = btn.getAttribute("data-id");
      const h = sorted.find(x => x.id === id);
      if (!h) return;

      const url = (act === "gmaps")
        ? googleMapsDirUrl(h.lat, h.lng, h.name)
        : wazeUrl(h.lat, h.lng);

      window.open(url, "_blank");
    });
  });
}

async function locateAndSort() {
  try {
    if (!navigator.geolocation) {
      setStatus("הדפדפן לא תומך Geolocation.", false);
      return;
    }

    setStatus("מאתר מיקום…");
    const pos = await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: true, timeout: 12000, maximumAge: 0
      });
    });

    myPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    setStatus(`מיקום נקלט: ${myPos.lat.toFixed(5)}, ${myPos.lng.toFixed(5)}`, true);

    el("addr").textContent = "מזהה כתובת (עיר/רחוב)…";
    el("addr").textContent = await reverseAddress(myPos.lat, myPos.lng);

    sorted = hospitals.map(h => ({
      ...h,
      air_km: haversineKm(myPos, { lat: Number(h.lat), lng: Number(h.lng) })
    })).sort((a,b) => a.air_km - b.air_km);

    render();
    el("btnOpenTop4").disabled = sorted.length < 1;

  } catch (e) {
    console.error(e);
    setStatus("נכשל איתור מיקום. אשר הרשאה ונסה שוב.", false);
  }
}

function openTopNGmaps() {
  if (!sorted.length) return;
  const top = sorted.slice(0, OPEN_TOP_N);

  // ניסיון לפתוח כמה כרטיסיות.
  // אם popups חסומים, ייפתח רק חלק.
  let opened = 0;

  top.forEach((h, i) => {
    const url = googleMapsDirUrl(h.lat, h.lng, h.name);
    setTimeout(() => {
      const w = window.open(url, "_blank");
      if (w) opened++;

      if (i === top.length - 1) {
        setTimeout(() => {
          if (opened < top.length) {
            alert("הדפדפן חסם חלק מהכרטיסיות. אפשר לאפשר Pop-ups לאתר כדי שייפתחו כולן.");
          }
        }, 250);
      }
    }, i * 250);
  });
}

/** events */
el("btnLocate").addEventListener("click", locateAndSort);
el("btnOpenTop4").addEventListener("click", openTopNGmaps);
el("search").addEventListener("input", render);

/** init: מנסה לאתר אוטומטית בטעינה */
window.addEventListener("load", locateAndSort);
</script>
</body>
</html>
