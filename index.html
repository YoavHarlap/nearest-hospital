<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fast2Care — פתח כמה יעדים בגוגל מפס</title>
  <style>
    body { font-family: system-ui, Arial; margin: 16px; line-height: 1.35; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin-top: 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input, button { padding: 10px; font-size: 16px; }
    button { cursor: pointer; }
    .muted { color: #555; }
    .ok { color: #0a7; }
    .bad { color: #c00; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #eee; padding: 8px; vertical-align: top; }
    th { background: #f7f7f7; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }
    .big { font-size: 16px; padding: 12px; font-weight: 700; }
    .stack { display:flex; flex-direction:column; gap:6px; }
  </style>
</head>
<body>
  <h2>Fast2Care — פתיחה מהירה של ETA בגוגל מפס</h2>
  <div class="muted">
    הדף ממיין אווירית, ואז בלחיצה אחת פותח כמה יעדים ב-Google Maps כדי שתראה זמני אמת (ETA) בכל טאב.
  </div>

  <div class="card">
    <h3>המיקום שלי</h3>
    <div class="row">
      <button id="btnLocate" class="big">אתר מיקום</button>
      <span id="status" class="muted">מוכן.</span>
      <span id="count" class="pill"></span>
    </div>
    <div id="addr" class="muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <h3>פעולה מהירה</h3>
    <div class="row">
      <button id="btnOpenTop5" class="big" disabled>פתח 5 הראשונים ב-Google Maps</button>
      <button id="btnOpenTop5Waze" disabled>פתח 5 הראשונים ב-Waze</button>
    </div>
    <div class="muted" style="margin-top:8px">
      אם כרום חוסם חלונות קופצים (Pop-ups), תאשר — אחרת ייפתח רק טאב אחד.
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">בתי חולים (ממויין לפי מרחק אווירי)</h3>
      <input id="search" placeholder="חיפוש לפי שם..." style="min-width:180px" />
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th style="width:46%">שם</th>
          <th style="width:18%">אווירי</th>
          <th style="width:36%">פתיחה מהירה</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
/** כמה טאבים לפתוח בלחיצה אחת */
const OPEN_TOP_N = 5;

/** דיפולט לדוגמה — החלף לרשימת 15 שלך */
const HOSPITALS = [
  { id: crypto.randomUUID(), name: "איכילוב (דוגמה)", lat: 32.0781, lng: 34.7898 },
  { id: crypto.randomUUID(), name: "שיבא תל השומר (דוגמה)", lat: 32.0460, lng: 34.8447 },
  { id: crypto.randomUUID(), name: "בלינסון (דוגמה)", lat: 32.0910, lng: 34.8814 },
  { id: crypto.randomUUID(), name: "וולפסון (דוגמה)", lat: 32.0168, lng: 34.7580 },
  { id: crypto.randomUUID(), name: "רמב\"ם חיפה (דוגמה)", lat: 32.8371, lng: 35.0506 },
];

let myPos = null;
let sorted = [];

const el = (id) => document.getElementById(id);

function setStatus(msg, ok=true) {
  el("status").textContent = msg;
  el("status").className = ok ? "ok" : "bad";
}

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

function haversineKm(a, b) {
  const R = 6371;
  const toRad = (x) => x * Math.PI / 180;
  const dLat = toRad(b.lat - a.lat);
  const dLng = toRad(b.lng - a.lng);
  const lat1 = toRad(a.lat);
  const lat2 = toRad(b.lat);
  const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
  return 2 * R * Math.asin(Math.min(1, Math.sqrt(h)));
}

function googleMapsDirUrl(destLat, destLng) {
  const base = "https://www.google.com/maps/dir/?api=1";
  const destination = `&destination=${encodeURIComponent(destLat + "," + destLng)}&travelmode=driving`;
  const origin = myPos ? `&origin=${encodeURIComponent(myPos.lat + "," + myPos.lng)}` : "";
  return base + destination + origin;
}
function wazeUrl(destLat, destLng) {
  return `https://waze.com/ul?ll=${encodeURIComponent(destLat + "," + destLng)}&navigate=yes`;
}

/** Reverse geocoding (עיר+רחוב) */
async function reverseAddress(lat, lng) {
  try {
    const url = new URL("https://nominatim.openstreetmap.org/reverse");
    url.searchParams.set("format", "jsonv2");
    url.searchParams.set("lat", lat);
    url.searchParams.set("lon", lng);
    url.searchParams.set("accept-language", "he");
    const r = await fetch(url.toString(), { headers: { "Accept": "application/json" }});
    if (!r.ok) throw new Error("reverse http " + r.status);
    const data = await r.json();
    const a = data.address || {};
    const city = a.city || a.town || a.village || a.municipality || "";
    const road = a.road || a.pedestrian || a.footway || "";
    const num  = a.house_number || "";
    const parts = [];
    if (city) parts.push(city);
    if (road) parts.push(road + (num ? " " + num : ""));
    return parts.length ? `זוהית ב: ${parts.join(", ")}` : "זוהית מיקום (לא הצלחתי לזהות כתובת).";
  } catch {
    return "זוהית מיקום (זיהוי כתובת נכשל).";
  }
}

function render() {
  const q = el("search").value.trim().toLowerCase();
  const list = sorted.filter(h => !q || h.name.toLowerCase().includes(q));
  el("count").textContent = `${list.length} מתוך ${sorted.length || HOSPITALS.length}`;

  const tbody = el("tbl").querySelector("tbody");
  tbody.innerHTML = "";

  list.forEach(h => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${escapeHtml(h.name)}</b></td>
      <td>${Number.isFinite(h.air_km) ? `${h.air_km.toFixed(1)} ק״מ` : `<span class="muted">—</span>`}</td>
      <td>
        <div class="stack">
          <button data-act="gmaps" data-id="${h.id}">Google Maps (ETA)</button>
          <button data-act="waze" data-id="${h.id}">Waze</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("button[data-act]").forEach(btn => {
    btn.addEventListener("click", () => {
      const act = btn.getAttribute("data-act");
      const id = btn.getAttribute("data-id");
      const h = sorted.find(x => x.id === id);
      if (!h) return;
      const url = act === "gmaps" ? googleMapsDirUrl(h.lat, h.lng) : wazeUrl(h.lat, h.lng);
      window.open(url, "_blank");
    });
  });
}

async function locateAndSort() {
  try {
    if (!navigator.geolocation) {
      setStatus("הדפדפן לא תומך Geolocation.", false);
      return;
    }
    setStatus("מאתר מיקום…");
    const pos = await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: true, timeout: 12000, maximumAge: 0
      });
    });
    myPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    setStatus(`מיקום נקלט: ${myPos.lat.toFixed(5)}, ${myPos.lng.toFixed(5)}`, true);

    el("addr").textContent = "מזהה עיר/רחוב…";
    el("addr").textContent = await reverseAddress(myPos.lat, myPos.lng);

    sorted = HOSPITALS.map(h => ({
      ...h,
      air_km: haversineKm(myPos, { lat: Number(h.lat), lng: Number(h.lng) })
    })).sort((a,b) => a.air_km - b.air_km);

    render();

    el("btnOpenTop5").disabled = false;
    el("btnOpenTop5Waze").disabled = false;

  } catch (e) {
    console.error(e);
    setStatus("נכשל איתור מיקום. אשר הרשאה ונסה שוב.", false);
  }
}

function openTopN(kind) {
  if (!sorted.length) return;
  const top = sorted.slice(0, OPEN_TOP_N);

  // חייב להיות מתוך קליק משתמש, אחרת pop-up blocker יחסום
  top.forEach((h, i) => {
    const url = (kind === "gmaps") ? googleMapsDirUrl(h.lat, h.lng) : wazeUrl(h.lat, h.lng);
    // דיליי קטן מפחית חסימה
    setTimeout(() => window.open(url, "_blank"), i * 250);
  });
}

/** events */
el("btnLocate").addEventListener("click", locateAndSort);
el("search").addEventListener("input", render);
el("btnOpenTop5").addEventListener("click", () => openTopN("gmaps"));
el("btnOpenTop5Waze").addEventListener("click", () => openTopN("waze"));

/** init */
sorted = HOSPITALS.slice();
render();
// אוטומטי בטעינה (עדיין יופיע אישור מיקום)
window.addEventListener("load", locateAndSort);
</script>
</body>
</html>
